<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Angsuran Berlangsung Elektronik </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { gold: { 500: '#d4af37', 600: '#b8941f' } },
          fontFamily: { poppins: ['Poppins', 'sans-serif'] }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg,#fff,#fffef0); }
    .badge { padding:.25rem .5rem; border-radius:9999px; font-size:.75rem; font-weight:600; border:1px solid rgba(0,0,0,.12); }
    .masa-cicilan-active { color:#f59e0b; font-weight:600; }
    .masa-cicilan-complete { color:#10b981; font-weight:600; }
    .whatsapp-link { color:#25D366; text-decoration:none; }
    .whatsapp-link:hover { text-decoration:underline; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 shadow-xl text-center">
      <div class="w-12 h-12 border-4 border-slate-200 border-t-gold-500 rounded-full animate-spin mx-auto mb-3"></div>
      <div class="text-sm text-slate-600">Memuat data‚Ä¶</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-slate-900 text-white text-sm shadow-lg"></div>

  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg md:text-2xl font-semibold">Angsuran Berlangsung Elektronik : <b id="npkLabel">-</b></h1>
      <div class="flex items-center gap-2">
        <span id="loggedAs" class="text-sm text-slate-500 hidden"></span>
        <a href="index.html" class="px-3 py-1.5 rounded-lg bg-gold-500 hover:bg-gold-600 text-white text-sm">üè† Menu Utama</a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Info -->
    <section class="bg-white rounded-2xl shadow p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <div>
        </div>
        <div id="countRows" class="text-sm text-slate-500"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border border-slate-200 rounded-xl overflow-hidden" id="tblData">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="px-2 py-2 text-left">#</th>
              <th class="px-2 py-2 text-left">ID</th>
              <th class="px-2 py-2 text-left">Tanggal</th>
              <th class="px-2 py-2 text-left">NPK</th>
              <th class="px-2 py-2 text-left">Nama</th>
              <th class="px-2 py-2 text-left">No. Telp</th>
              <th class="px-2 py-2 text-left">Instalasi</th>
              <th class="px-2 py-2 text-left">Cicilan</th>
              <th class="px-2 py-2 text-left">Tipe HP</th>
              <th class="px-2 py-2 text-left">Alamat Kirim</th>
              <th class="px-2 py-2 text-left">Keterangan</th>
              <th class="px-2 py-2 text-left">Status</th>
              <th class="px-2 py-2 text-left">Masa Cicilan</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ===== KONFIG =====
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxHylq0kuwja-7FQgHwYas-bh9GUUKChEPZ6stylR37gBWtqyFDKe7OsZCov2aoUmPi/exec';

    // ===== Utils =====
    const $ = (sel) => document.querySelector(sel);
    const showLoading = (b) => { const el = $('#loading'); b ? (el.style.display='flex') : (el.style.display='none'); };
    const toast = (msg, ok=true) => {
      const t = $('#toast'); t.textContent = msg;
      t.className = "fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm shadow-lg " + (ok ? "bg-gold-500 text-white" : "bg-rose-600 text-white");
      t.style.opacity = 1; t.style.display = 'block';
      setTimeout(()=>{ t.style.opacity = 0; setTimeout(()=>t.style.display='none', 300) }, 2000);
    };
    const esc = (s) => (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function getParam(name){ const u = new URLSearchParams(window.location.search); return u.get(name) || ''; }

    // ===== Username (NPK) dari sesi =====
    function getLoggedUsername(){
      const fromParam = getParam('user')?.trim();
      if (fromParam) return fromParam;
      try {
        const ss = sessionStorage.getItem('username');
        if (ss) return ss.trim();
      } catch(_) {}
      return '';
    }

    // ===== Date helpers =====
    function fmtDDMMYYYY(d){
      const dd=String(d.getDate()).padStart(2,'0');
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const yy=d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function formatDateToDDMMYYYY(val){
      if(!val) return "";
      if(typeof val==='string' && val.includes('/')) {
        const [d,m,y]=val.split('/');
        if(d&&m&&y) return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
      }
      const d=new Date(val);
      if(isNaN(d)) return "";
      return fmtDDMMYYYY(d);
    }

    // ===== Render tabel =====
    function renderTable(rows){
      const tb = $('#tbody'); tb.innerHTML = '';
      $('#countRows').textContent = `${rows.length} baris`;

      if(!rows.length){
        tb.innerHTML = `<tr><td colspan="13" class="px-3 py-6 text-center text-slate-500">Tidak ada data</td></tr>`;
        return;
      }

      rows.forEach((r, i)=>{
        // WhatsApp link (kalau ada r.notelp_link)
        let telHtml = esc(r.notelp || '');
        if (r.notelp_link) {
          telHtml = `<a href="${esc(r.notelp_link)}" target="_blank" rel="noopener" class="whatsapp-link">${esc(r.notelp || '')} <span class="inline-block">üì≤</span></a>`;
        }

        // Warna masa cicilan
        let masaHtml = esc(r.masaCicilan || '');
        if (r.masaCicilan) {
          const low = r.masaCicilan.toLowerCase();
          if (low.includes('lunas') || low.includes('selesai')) {
            masaHtml = `<span class="masa-cicilan-complete">${esc(r.masaCicilan)}</span>`;
          } else if (low.includes('sisa') || low.includes('masih')) {
            masaHtml = `<span class="masa-cicilan-active">${esc(r.masaCicilan)}</span>`;
          }
        }

        // Badge status
        const st = String(r.status || '').toUpperCase();
        let stClass = 'border-slate-300 text-slate-600';
        if (st === 'OK') stClass = 'border-emerald-300 text-emerald-700';
        else if (st === 'VERIFIKASI') stClass = 'border-amber-300 text-amber-700';
        else if (st === 'NO ACC') stClass = 'border-rose-300 text-rose-700';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';
        tr.innerHTML = `
          <td class="px-2 py-2 text-sm text-slate-600">${i+1}</td>
          <td class="px-2 py-2 text-sm">${esc(r.id)}</td>
          <td class="px-2 py-2 text-sm">${esc(formatDateToDDMMYYYY(r.tanggal))}</td>
          <td class="px-2 py-2 text-sm">${esc(r.npk)}</td>
          <td class="px-2 py-2 text-sm">${esc(r.nama || '')}</td>
          <td class="px-2 py-2">${telHtml}</td>
          <td class="px-2 py-2 text-sm">${esc(r.instalasi || '')}</td>
          <td class="px-2 py-2 text-sm">${esc(r.cicilan || '')}</td>
          <td class="px-2 py-2 text-sm">${esc(r.tipehp || '')}</td>
          <td class="px-2 py-2 text-sm">${esc(r.alamat || '')}</td>
          <td class="px-2 py-2 text-sm">${esc(r.keterangan || '')}</td>
          <td class="px-2 py-2 text-sm"><span class="badge ${stClass}">${esc(st)}</span></td>
          <td class="px-2 py-2 text-sm">${masaHtml}</td>
        `;
        tb.appendChild(tr);
      });
    }

    // ===== Load data =====
    async function loadDataForUser(uname){
      $('#npkLabel').textContent = uname;
      $('#loggedAs').textContent = 'Masuk sebagai: ' + uname;
      $('#loggedAs').classList.remove('hidden');

      showLoading(true);
      try {
        const url = `${ENDPOINT}?action=getData&npk=${encodeURIComponent(uname)}`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.status !== 'success') {
          toast(json.message || 'Gagal memuat data', false);
          renderTable([]);
          return;
        }
        renderTable(json.data || []);
      } catch (err) {
        toast('Error: ' + err.message, false);
        renderTable([]);
      } finally {
        showLoading(false);
      }
    }

    // ===== Auto-run saat halaman dimuat =====
    document.addEventListener('DOMContentLoaded', async () => {
      const uname = getLoggedUsername();
      if (!uname) {
        toast('Tidak ada sesi login. Silakan kembali ke halaman login.', false);
        $('#infoNote').textContent = 'Sesi tidak ditemukan. Kembali ke menu utama untuk login.';
        $('#npkLabel').textContent = '-';
        renderTable([]);
        return;
      }
      await loadDataForUser(uname);
    });
  </script>
</body>
</html>
